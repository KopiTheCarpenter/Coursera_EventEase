@page "/register"
@page "/register/{eventId:int}"
@using EventEase.Services
@using EventEase.Models
@inject EventService EventService
@inject UserSession userSession
@inject NavigationManager Navigation

<h3>Registration</h3>

@if (eventId.HasValue)
{
    <p>Registering for: <strong>@eventItem?.Name</strong></p>
}
else{
    <div class="mb-3">
        <label>Select Event</label>
        <InputSelect class="form-control" @bind-Value="registration.EventId">
            <option selected="selected" value="0">-- choose an event --</option>
            @foreach (var ev in EventService.GetEvents())
            {
                <option value="@ev.Id">@ev.Name (@ev.Date.ToShortDateString())</option>
            }
        </InputSelect>
    </div>
}

<EditForm Model="@registration" OnValidSubmit="HandleSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label>Name</label>
        <InputText class="form-control" @bind-Value="registration.Name" />
    </div>

    <div class="mb-3">
        <label>Email</label>
        <InputText class="form-control" @bind-Value="registration.Email" />
    </div>

    <button class="btn btn-primary" type="submit">Submit</button>
    <NavLink class="btn btn-secondary" href="/events">Back to events</NavLink>
</EditForm>

@code {
    [Parameter] public int? eventId { get; set; }
    private Event? eventItem;

    private Registration registration = new();

    protected override void OnParametersSet()
    {
        if (eventId.HasValue)
        {
            eventItem = EventService.GetEventById(eventId.Value);
            registration.EventId = eventId.Value;
        }
    }

    private void HandleSubmit()
    {
        // Add a new registration record
        userSession.Registrations.Add(new Registration
        {
            Name = registration.Name,
            Email = registration.Email,
            EventId = registration.EventId
        });

        Navigation.NavigateTo("/attendance");
    }

}
